<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LFF Marketplace - Buy Commodities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        /* Updated Navigation Bar */
        .navbar {
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #28a745;
            font-size: 1.2rem;
        }

        .nav-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .logo {
            color: #212529;
            font-size: 1.8rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 1rem;
        }

        .nav-links a {
            color: #495057;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover {
            background-color: #f8f9fa;
            color: #28a745;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            color: #495057;
            text-decoration: none;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
            font-weight: 500;
        }

        .back-btn:hover {
            background: #e9ecef;
            color: #28a745;
            border-color: #28a745;
        }

        /* Sidebar styles matching dashboard */
        .sidebar {
            width: 280px;
            background: white;
            color: #495057;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
            border-right: 2px solid #e9ecef;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            text-align: center;
            background: #f8f9fa;
        }

        .sidebar-header h3 {
            color: #212529;
            margin: 0.5rem 0 0 0;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6c757d;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #f8f9fa;
            border-left-color: #28a745;
            color: #28a745;
        }

        .nav-link.active {
            background: #e8f5e8;
            border-left-color: #28a745;
            color: #28a745;
            font-weight: 600;
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
            color: inherit;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.5rem;
            border: 1px solid;
            background: #fff;
            color: #28a745;
            border-color: #28a745;
        }

        /* Adjust main content for sidebar */
        .main-content {
            margin-left: 280px;
            padding: 2.5rem;
            background: transparent;
            min-height: 100vh;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .page-header h1 {
            color: #1e293b;
            margin-bottom: 0.75rem;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .page-header p {
            color: #64748b;
            font-size: 1.25rem;
            font-weight: 500;
        }

        /* Enhanced Search Section */
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 1.25rem 3rem 1.25rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1);
            transform: translateY(-2px);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        /* Enhanced Filter Section */
        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .filter-header {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-header i {
            color: #28a745;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-input,
        .filter-select {
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1);
        }

        /* Enhanced Marketplace Cards */
        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .commodity-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .commodity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28a745, #20c997, #ffc107);
        }

        .commodity-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .commodity-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
        }

        .commodity-title {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .commodity-category {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
            background: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
        }

        .commodity-price {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .commodity-details {
            margin-bottom: 1.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-label {
            color: #64748b;
            font-weight: 500;
        }

        .detail-value {
            color: #1e293b;
            font-weight: 600;
        }

        .commodity-description {
            color: #475569;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #28a745;
        }

        .commodity-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #475569;
            padding: 0.875rem 1.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
        }

        .btn-secondary:hover {
            background: white;
            border-color: #28a745;
            color: #28a745;
            transform: translateY(-2px);
        }

        /* Enhanced Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-available {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
        }

        .status-negotiation {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .status-sold {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }

        /* Enhanced Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px dashed #e2e8f0;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #64748b;
        }

        /* Enhanced Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .marketplace-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .commodity-actions {
                flex-direction: column;
            }

            .search-section,
            .filter-section {
                padding: 1.5rem;
                border-radius: 16px;
            }

            .commodity-card {
                padding: 1.5rem;
                border-radius: 16px;
            }
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6 {
            color: #1e293b;
            font-weight: 700;
        }

        p {
            line-height: 1.6;
            color: #64748b;
        }

        /* Enhanced Animations */
        .commodity-card {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            height: 90vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 20px 20px 0 0;
        }

        .modal-title {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .close {
            color: #64748b;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #dc3545;
        }

        .modal-body {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Negotiation Info */
        .negotiation-info {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #28a745;
        }

        .commodity-summary {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .commodity-info h4 {
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .commodity-meta {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .price-info {
            text-align: right;
        }

        .current-price {
            color: #28a745;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .availability {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Enhanced Offer Section */
        .offer-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #e2e8f0;
        }

        .offer-section h4 {
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .offer-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .offer-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .offer-input-group label {
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .offer-input {
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .offer-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .btn-negotiate {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-negotiate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .offer-total {
            grid-column: 1 / -1;
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Enhanced Chat Container */
        .chat-container {
            flex: 1;
            background: white;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 1rem;
            min-height: 300px;
        }

        .chat-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #fafbfc;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 16px;
            max-width: 75%;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.buyer {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.seller {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message.offer {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #92400e;
            margin: 0 auto;
            text-align: center;
            max-width: 90%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.5;
        }

        .offer-details {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .offer-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            justify-content: center;
        }

        .offer-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .offer-btn.accept {
            background: #22c55e;
            color: white;
        }

        .offer-btn.counter {
            background: #f59e0b;
            color: white;
        }

        .offer-btn.decline {
            background: #ef4444;
            color: white;
        }

        .offer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Chat Input */
        .chat-input {
            display: flex;
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            gap: 0.75rem;
            align-items: end;
        }

        .message-input {
            flex: 1;
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            resize: none;
            font-family: inherit;
            max-height: 100px;
            min-height: 44px;
        }

        .message-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: #f1f5f9;
            border-radius: 16px;
            margin: 0.5rem 0;
            max-width: 75%;
            color: #64748b;
            font-style: italic;
        }

        .typing-dots {
            display: inline-flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #64748b;
            border-radius: 50%;
            animation: typingDot 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Negotiation Status */
        .negotiation-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-icon.active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .status-icon.pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .status-text h5 {
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .status-text p {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                height: 95vh;
                margin: 2.5% auto;
            }

            .modal-body {
                padding: 1rem;
            }

            .offer-form {
                grid-template-columns: 1fr;
            }

            .commodity-summary {
                flex-direction: column;
                gap: 1rem;
            }

            .price-info {
                text-align: left;
            }

            .message {
                max-width: 85%;
            }
        }

        /* Enhanced Fonts */
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <!-- Font Awesome for icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <div class="nav-logo">
                    <img src="Assets/logo.png" alt="LFF Logo">
                </div>
                <a href="#" class="logo">LFF Marketplace</a>
            </div>
            
            <div class="nav-right">
                <a href="dashboard.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="nav-logo">
                <img src="Assets/logo.png" alt="LFF Logo" style="width: 40px; height: 40px;">
            </div>
            <h3>LFF Marketplace</h3>
            <div id="sidebarUserRole" class="role-badge">User</div>
        </div>

        <nav class="sidebar-nav">
            <!-- Core Navigation -->
            <div class="nav-section">
                <div class="section-title">Navigation</div>
                <div class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="fas fa-shopping-basket"></i>
                        <span>Buy Commodities</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="onboarding.html" class="nav-link">
                        <i class="fas fa-upload"></i>
                        <span>Sell/Onboard Commodity</span>
                    </a>
                </div>
            </div>

            <!-- Marketplace Actions -->
            <div class="nav-section">
                <div class="section-title">Marketplace</div>
                <div class="nav-item">
                    <a href="#browse" class="nav-link" onclick="showSection('browse')">
                        <i class="fas fa-search"></i>
                        <span>Browse Commodities</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#watchlist" class="nav-link" onclick="showSection('watchlist')">
                        <i class="fas fa-heart"></i>
                        <span>My Watchlist</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#orders" class="nav-link" onclick="showSection('orders')">
                        <i class="fas fa-shopping-cart"></i>
                        <span>My Orders</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#negotiations" class="nav-link" onclick="showSection('negotiations')">
                        <i class="fas fa-handshake"></i>
                        <span>Active Negotiations</span>
                    </a>
                </div>
            </div>

            <!-- Account -->
            <div class="nav-section">
                <div class="section-title">Account</div>
                <div class="nav-item">
                    <a href="#profile" class="nav-link" onclick="showSection('profile')">
                        <i class="fas fa-user"></i>
                        <span>My Profile</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#settings" class="nav-link" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>

    <!-- Enhanced Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1>Commodity Marketplace</h1>
            <p>Discover and purchase quality agricultural products</p>
        </div>

        <!-- Enhanced Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search commodities, farmers, locations..." id="searchInput">
                <button class="search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Enhanced Filter Section -->
        <div class="filter-section">
            <div class="filter-header">
                <i class="fas fa-filter"></i>
                Filter Commodities
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="filter-select" id="categoryFilter" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        <option value="grains">Grains & Cereals</option>
                        <option value="livestock">Livestock</option>
                        <option value="poultry">Poultry</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Price Range (USD)</label>
                    <input type="range" class="filter-input" id="priceRange" min="0" max="1000" onchange="applyFilters()">
                    <small id="priceRangeValue">$0 - $1000</small>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Location</label>
                    <select class="filter-select" id="locationFilter" onchange="applyFilters()">
                        <option value="">All Locations</option>
                        <option value="harare">Harare</option>
                        <option value="bulawayo">Bulawayo</option>
                        <option value="mutare">Mutare</option>
                        <option value="gweru">Gweru</option>
                        <option value="masvingo">Masvingo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Availability</label>
                    <select class="filter-select" id="availabilityFilter" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="negotiation">In Negotiation</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Enhanced Marketplace Grid -->
        <div class="marketplace-grid" id="commodityGrid">
            <!-- Commodities will be loaded dynamically here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-seedling"></i>
            <h3>No commodities found</h3>
            <p>Be the first to list your agricultural products on our marketplace!</p>
            <a href="onboarding.html" class="btn-primary" style="margin-top: 1rem; text-decoration: none; display: inline-block;">
                <i class="fas fa-plus"></i> List Your Commodity
            </a>
        </div>
    </div>

    <!-- Enhanced Negotiation Modal -->
    <div id="negotiationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Negotiate Purchase</h2>
                <span class="close" onclick="closeNegotiationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Commodity Information -->
                <div class="negotiation-info" id="negotiationInfo">
                    <!-- Commodity info will be loaded here -->
                </div>

                <!-- Negotiation Status -->
                <div class="negotiation-status">
                    <div class="status-icon active">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="status-text">
                        <h5>Active Negotiation</h5>
                        <p>You can make offers and chat with the seller in real-time</p>
                    </div>
                </div>

                <!-- Make Offer Section -->
                <div class="offer-section">
                    <h4><i class="fas fa-tag"></i> Make an Offer</h4>
                    <div class="offer-form">
                        <div class="offer-input-group">
                            <label>Price per unit ($)</label>
                            <input type="number" id="offerPrice" class="offer-input" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        </div>
                        <div class="offer-input-group">
                            <label>Quantity</label>
                            <input type="number" id="offerQuantity" class="offer-input" placeholder="0" min="1" oninput="calculateTotal()">
                        </div>
                        <button class="btn-negotiate" onclick="makeOffer()">
                            <i class="fas fa-paper-plane"></i>
                            Send Offer
                        </button>
                        <div class="offer-total" id="offerTotal" style="display: none;">
                            Total: $0.00
                        </div>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h4><i class="fas fa-comments"></i> Negotiation Chat</h4>
                        <div class="chat-status">
                            <div class="status-indicator"></div>
                            <span>Online</span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        <span id="typingUser">Seller</span> is typing
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <textarea id="messageInput" class="message-input" rows="1" placeholder="Type your message here..." onkeydown="handleMessageKeyDown(event)"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load user data and initialize
        let currentUser = null;
        let activeNegotiation = null;
        let chatMessages = [];
        let isTyping = false;
        let typingTimeout = null;
        let messageCounter = 0;

        // Simulated real-time connection
        let simulatedConnection = null;

        function loadUserFromSession() {
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'login.html';
                return null;
            }
            return JSON.parse(userData);
        }

        // Function to load and display commodities
        function loadCommodities() {
            const commodityGrid = document.getElementById('commodityGrid');
            const emptyState = document.getElementById('emptyState');
            
            // Get commodities from localStorage
            const listedCommodities = JSON.parse(localStorage.getItem('listedCommodities')) || [];
            
            if (listedCommodities.length === 0) {
                commodityGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            commodityGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Clear existing content
            commodityGrid.innerHTML = '';
            
            // Create commodity cards
            listedCommodities.forEach(commodity => {
                const commodityCard = createCommodityCard(commodity);
                commodityGrid.appendChild(commodityCard);
            });
        }

        // Function to create commodity card HTML
        function createCommodityCard(commodity) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'commodity-card';
            
            // Format listing date
            const listingDate = new Date(commodity.listingDate).toLocaleDateString();
            
            // Get status badge class
            const statusClass = commodity.status === 'available' ? 'status-available' : 
                               commodity.status === 'negotiation' ? 'status-negotiation' : 'status-sold';
            
            cardDiv.innerHTML = `
                <div class="commodity-header">
                    <div>
                        <h3 class="commodity-title">${commodity.title}</h3>
                        <p class="commodity-category">${commodity.categoryDisplayName}</p>
                    </div>
                    <div class="commodity-price">$${commodity.price}/${commodity.unit || 'unit'}</div>
                </div>
                <div class="commodity-details">
                    <div class="detail-row">
                        <span class="detail-label">Available:</span>
                        <span class="detail-value">${commodity.quantity} ${commodity.unit || 'units'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Seller:</span>
                        <span class="detail-value">${commodity.sellerName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">${commodity.location}</span>
                    </div>
                    ${commodity.grade ? `
                    <div class="detail-row">
                        <span class="detail-label">Grade:</span>
                        <span class="detail-value">${commodity.grade}</span>
                    </div>
                    ` : ''}
                    ${commodity.breed ? `
                    <div class="detail-row">
                        <span class="detail-label">Breed:</span>
                        <span class="detail-value">${commodity.breed}</span>
                    </div>
                    ` : ''}
                    ${commodity.age ? `
                    <div class="detail-row">
                        <span class="detail-label">Age:</span>
                        <span class="detail-value">${commodity.age}</span>
                    </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">Listed:</span>
                        <span class="detail-value">${listingDate}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="status-badge ${statusClass}">${commodity.status}</span>
                    </div>
                </div>
                <div class="commodity-description">
                    ${commodity.description}
                </div>
                ${commodity.images && commodity.images.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <p style="color: #28a745; font-weight: 600; font-size: 0.9rem;">
                        <i class="fas fa-image"></i> ${commodity.images.length} image(s) available
                    </p>
                </div>
                ` : ''}
                <div class="commodity-actions">
                    <button class="btn-primary" onclick="initiateNegotiation('${commodity.id}')">
                        <i class="fas fa-handshake"></i> Negotiate
                    </button>
                    <button class="btn-secondary" onclick="addToWatchlist('${commodity.id}')">
                        <i class="far fa-heart"></i> Watch
                    </button>
                </div>
            `;
            
            return cardDiv;
        }

        function initiateNegotiation(commodityId) {
            // Get commodity from localStorage
            const listedCommodities = JSON.parse(localStorage.getItem('listedCommodities')) || [];
            const commodity = listedCommodities.find(c => c.id === commodityId);
            
            if (!commodity) {
                alert('Commodity not found.');
                return;
            }

            // Initialize negotiation
            activeNegotiation = {
                commodityId: commodityId,
                commodity: commodity,
                buyer: currentUser,
                seller: { name: commodity.sellerName, id: commodity.sellerId },
                startTime: new Date(),
                status: 'active',
                offers: []
            };

            // Setup modal
            setupNegotiationModal();
            
            // Initialize chat
            initializeChat();
            
            // Start simulated real-time updates
            startRealTimeSimulation();
            
            // Show modal
            document.getElementById('negotiationModal').style.display = 'block';
        }

        function setupNegotiationModal() {
            const commodity = activeNegotiation.commodity;
            
            document.getElementById('modalTitle').textContent = `Negotiate: ${commodity.title}`;
            
            document.getElementById('negotiationInfo').innerHTML = `
                <div class="commodity-summary">
                    <div class="commodity-info">
                        <h4>${commodity.title}</h4>
                        <div class="commodity-meta">
                            <p><strong>Seller:</strong> ${commodity.sellerName}</p>
                            <p><strong>Location:</strong> ${commodity.location}</p>
                            <p><strong>Category:</strong> ${commodity.categoryDisplayName}</p>
                            ${commodity.grade ? `<p><strong>Grade:</strong> ${commodity.grade}</p>` : ''}
                            ${commodity.breed ? `<p><strong>Breed:</strong> ${commodity.breed}</p>` : ''}
                        </div>
                    </div>
                    <div class="price-info">
                        <div class="current-price">$${parseFloat(commodity.price).toFixed(2)}</div>
                        <div class="availability">Available: ${commodity.quantity} ${commodity.unit}</div>
                    </div>
                </div>
                <p style="color: #475569; margin-top: 1rem;">${commodity.description}</p>
            `;

            // Set max quantity for offer
            document.getElementById('offerQuantity').max = commodity.quantity;
        }

        function initializeChat() {
            chatMessages = [];
            
            // Clear chat messages
            document.getElementById('chatMessages').innerHTML = '';
            
            // Add welcome message from seller
            addMessage('seller', activeNegotiation.seller.name, 
                `Hello! Thank you for your interest in my ${activeNegotiation.commodity.title}. I'm looking forward to working with you. Feel free to make an offer or ask any questions!`
            );
        }

        function startRealTimeSimulation() {
            // Clear any existing simulation
            if (simulatedConnection) {
                clearInterval(simulatedConnection);
            }
            
            // Simulate seller being online and responsive
            simulatedConnection = setInterval(() => {
                // Random chance of seller sending a message (very low probability)
                if (Math.random() < 0.02 && chatMessages.length > 1) {
                    const responses = [
                        "Is there anything specific you'd like to know about the product?",
                        "I'm flexible on the price for bulk purchases.",
                        "The quality is excellent - I've been farming for over 15 years.",
                        "I can arrange delivery if needed."
                    ];
                    
                    setTimeout(() => {
                        addMessage('seller', activeNegotiation.seller.name, 
                            responses[Math.floor(Math.random() * responses.length)]
                        );
                    }, 2000 + Math.random() * 3000);
                }
            }, 10000); // Check every 10 seconds
        }

        function calculateTotal() {
            const price = parseFloat(document.getElementById('offerPrice').value) || 0;
            const quantity = parseInt(document.getElementById('offerQuantity').value) || 0;
            const total = price * quantity;
            
            const totalElement = document.getElementById('offerTotal');
            if (price > 0 && quantity > 0) {
                totalElement.style.display = 'block';
                totalElement.textContent = `Total: $${total.toFixed(2)}`;
            } else {
                totalElement.style.display = 'none';
            }
        }

        function makeOffer() {
            const price = parseFloat(document.getElementById('offerPrice').value);
            const quantity = parseInt(document.getElementById('offerQuantity').value);
            
            if (!price || !quantity) {
                alert('Please enter both price and quantity for your offer.');
                return;
            }

            if (quantity > activeNegotiation.commodity.quantity) {
                alert('Offer quantity cannot exceed available quantity.');
                return;
            }

            const total = price * quantity;
            const originalTotal = activeNegotiation.commodity.price * quantity;
            const savingsPercent = ((originalTotal - total) / originalTotal * 100).toFixed(1);

            // Create offer
            const offer = {
                id: Date.now(),
                buyerId: currentUser.userId,
                sellerId: activeNegotiation.commodity.sellerId,
                pricePerUnit: price,
                quantity: quantity,
                totalAmount: total,
                originalAmount: originalTotal,
                savings: originalTotal - total,
                savingsPercent: savingsPercent,
                timestamp: new Date(),
                status: 'pending'
            };

            activeNegotiation.offers.push(offer);

            // Add offer message to chat
            addOfferMessage(offer);

            // Clear inputs
            document.getElementById('offerPrice').value = '';
            document.getElementById('offerQuantity').value = '';
            document.getElementById('offerTotal').style.display = 'none';

            // Simulate seller response
            setTimeout(() => {
                simulateSellerResponse(offer);
            }, 3000 + Math.random() * 5000);
        }

        function addOfferMessage(offer) {
            const messageId = `msg-${Date.now()}`;
            const messageHtml = `
                <div class="message offer" id="${messageId}">
                    <div class="message-header">
                        <span><strong>OFFER MADE</strong></span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <div class="offer-details">
                            <p><strong>Price:</strong> $${offer.pricePerUnit.toFixed(2)} per ${activeNegotiation.commodity.unit}</p>
                            <p><strong>Quantity:</strong> ${offer.quantity} ${activeNegotiation.commodity.unit}</p>
                            <p><strong>Total Amount:</strong> $${offer.totalAmount.toFixed(2)}</p>
                            ${offer.savings > 0 ? 
                                `<p style="color: #22c55e;"><strong>Your Savings:</strong> $${offer.savings.toFixed(2)} (${offer.savingsPercent}%)</p>` : 
                                `<p style="color: #ef4444;"><strong>Premium:</strong> $${Math.abs(offer.savings).toFixed(2)} (${Math.abs(offer.savingsPercent)}%)</p>`
                            }
                        </div>
                        <div class="offer-actions" id="offer-actions-${offer.id}">
                            <div style="color: #f59e0b; font-weight: 600;">
                                <i class="fas fa-clock"></i> Waiting for seller response...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML += messageHtml;
            scrollToBottom();
        }

        function simulateSellerResponse(offer) {
            const originalPrice = activeNegotiation.commodity.price;
            const offerPrice = offer.pricePerUnit;
            const priceRatio = offerPrice / originalPrice;

            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();

                let responseText = '';
                let responseType = '';

                if (priceRatio >= 0.95) {
                    // Accept offer (95% or more of asking price)
                    responseText = `Great offer! I accept your proposal of $${offerPrice.toFixed(2)} per ${activeNegotiation.commodity.unit} for ${offer.quantity} ${activeNegotiation.commodity.unit}. Let's proceed with the transaction!`;
                    responseType = 'accept';
                    updateOfferStatus(offer.id, 'accepted');
                } else if (priceRatio >= 0.85) {
                    // Counter offer (85-94% of asking price)
                    const counterPrice = (originalPrice * 0.9).toFixed(2);
                    responseText = `Thank you for the offer. I can come down to $${counterPrice} per ${activeNegotiation.commodity.unit}. This is my best price for the quality I'm offering. What do you think?`;
                    responseType = 'counter';
                    updateOfferStatus(offer.id, 'countered');
                } else if (priceRatio >= 0.7) {
                    // Polite decline with counter (70-84% of asking price)
                    const counterPrice = (originalPrice * 0.85).toFixed(2);
                    responseText = `I appreciate your interest, but that price is quite low. The lowest I can go is $${counterPrice} per ${activeNegotiation.commodity.unit}. The quality is exceptional and worth the price.`;
                    responseType = 'counter';
                    updateOfferStatus(offer.id, 'countered');
                } else {
                    // Decline (less than 70% of asking price)
                    responseText = `I'm sorry, but I cannot accept that offer as it's significantly below my costs. My minimum price would be $${(originalPrice * 0.8).toFixed(2)} per ${activeNegotiation.commodity.unit}. I hope you understand.`;
                    responseType = 'decline';
                    updateOfferStatus(offer.id, 'declined');
                }

                addMessage('seller', activeNegotiation.seller.name, responseText);

                // If accepted, show next steps
                if (responseType === 'accept') {
                    setTimeout(() => {
                        addMessage('seller', activeNegotiation.seller.name, 
                            "I'll prepare the paperwork. Please let me know your preferred delivery method and timeline. We can arrange payment through the LFF Smart Accounts system."
                        );
                    }, 2000);
                }
            }, 2000 + Math.random() * 3000);
        }

        function updateOfferStatus(offerId, status) {
            const actionsElement = document.getElementById(`offer-actions-${offerId}`);
            if (!actionsElement) return;

            let statusHtml = '';
            switch(status) {
                case 'accepted':
                    statusHtml = `
                        <div style="color: #22c55e; font-weight: 600;">
                            <i class="fas fa-check-circle"></i> Offer Accepted!
                        </div>
                        <button class="offer-btn accept" onclick="proceedWithPurchase(${offerId})">
                            Proceed to Payment
                        </button>
                    `;
                    break;
                case 'countered':
                    statusHtml = `
                        <div style="color: #f59e0b; font-weight: 600;">
                            <i class="fas fa-exchange-alt"></i> Seller Made Counter Offer
                        </div>
                    `;
                    break;
                case 'declined':
                    statusHtml = `
                        <div style="color: #ef4444; font-weight: 600;">
                            <i class="fas fa-times-circle"></i> Offer Declined
                        </div>
                    `;
                    break;
            }
            actionsElement.innerHTML = statusHtml;
        }

        function addMessage(sender, senderName, content) {
            messageCounter++;
            const messageId = `msg-${messageCounter}`;
            const senderClass = sender === 'buyer' ? 'buyer' : 'seller';
            const time = new Date().toLocaleTimeString();
            
            const messageHtml = `
                <div class="message ${senderClass}" id="${messageId}">
                    <div class="message-header">
                        <span><strong>${senderName}</strong></span>
                        <span>${time}</span>
                    </div>
                    <div class="message-content">${content}</div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML += messageHtml;
            scrollToBottom();
            chatMessages.push({ id: messageId, sender, senderName, content, timestamp: new Date() });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;

            addMessage('buyer', currentUser.fullName, content);
            messageInput.value = '';
            
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            
            // Simulate seller typing and response
            setTimeout(() => {
                if (Math.random() < 0.7) { // 70% chance of seller responding
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        const responses = [
                            "Thanks for the message! Let me know if you have any other questions.",
                            "I appreciate your interest. Is there anything specific you'd like to know?",
                            "Absolutely! I'm here to help with any questions you might have.",
                            "That sounds good. I'm flexible and want to make sure you're satisfied.",
                            "Of course! I've been in this business for years and quality is my priority."
                        ];
                        addMessage('seller', activeNegotiation.seller.name, 
                            responses[Math.floor(Math.random() * responses.length)]
                        );
                    }, 2000 + Math.random() * 3000);
                }
            }, 1000 + Math.random() * 2000);
        }

        function handleMessageKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function proceedWithPurchase(offerId) {
            const offer = activeNegotiation.offers.find(o => o.id === offerId);
            if (!offer) return;

            alert(`Proceeding with purchase!\n\nTotal Amount: $${offer.totalAmount.toFixed(2)}\n\nYou will be redirected to the LFF Smart Accounts payment system.`);
            
            // In a real app, this would redirect to payment processing
            console.log('Processing payment for offer:', offer);
            
            // Close modal
            closeNegotiationModal();
        }

        function closeNegotiationModal() {
            document.getElementById('negotiationModal').style.display = 'none';
            
            // Clear simulation
            if (simulatedConnection) {
                clearInterval(simulatedConnection);
                simulatedConnection = null;
            }
            
            // Reset state
            activeNegotiation = null;
            chatMessages = [];
            messageCounter = 0;
        }

        // Fixed search function
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const searchBtn = document.querySelector('.search-btn');
            
            // Add loading spinner
            const originalContent = searchBtn.innerHTML;
            searchBtn.innerHTML = '<div class="loading-spinner"></div>';
            
            setTimeout(() => {
                searchBtn.innerHTML = originalContent;
                
                if (!searchTerm.trim()) {
                    loadCommodities();
                    return;
                }
                
                // Get all commodities and filter by search term
                const listedCommodities = JSON.parse(localStorage.getItem('listedCommodities')) || [];
                const filteredCommodities = listedCommodities.filter(commodity => 
                    commodity.title.toLowerCase().includes(searchTerm) ||
                    commodity.name.toLowerCase().includes(searchTerm) ||
                    commodity.description.toLowerCase().includes(searchTerm) ||
                    commodity.sellerName.toLowerCase().includes(searchTerm) ||
                    commodity.location.toLowerCase().includes(searchTerm)
                );
                
                // Update display
                const commodityGrid = document.getElementById('commodityGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (filteredCommodities.length === 0) {
                    commodityGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h3>No results found for "${searchTerm}"</h3>
                        <p>Try searching with different keywords or browse all commodities.</p>
                        <button class="btn-primary" onclick="clearSearch()" style="margin-top: 1rem;">
                            <i class="fas fa-times"></i> Clear Search
                        </button>
                    `;
                } else {
                    commodityGrid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    
                    // Clear and repopulate grid
                    commodityGrid.innerHTML = '';
                    filteredCommodities.forEach(commodity => {
                        const commodityCard = createCommodityCard(commodity);
                        commodityGrid.appendChild(commodityCard);
                    });
                }
                
                console.log('Search results:', filteredCommodities.length, 'commodities found for:', searchTerm);
            }, 1000);
        }

        // Function to clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            loadCommodities();
        }

        // Function to apply filters
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const priceRange = document.getElementById('priceRange').value;
            const location = document.getElementById('locationFilter').value;
            const availability = document.getElementById('availabilityFilter').value;
            
            // Update price range display
            document.getElementById('priceRangeValue').textContent = `$0 - $${priceRange}`;
            
            // Get all commodities
            const listedCommodities = JSON.parse(localStorage.getItem('listedCommodities')) || [];
            
            // Apply filters
            let filteredCommodities = listedCommodities.filter(commodity => {
                // Category filter
                if (category && commodity.category !== category) return false;
                
                // Price filter
                if (priceRange && parseFloat(commodity.price) > parseFloat(priceRange)) return false;
                
                // Location filter
                if (location && !commodity.location.toLowerCase().includes(location.toLowerCase())) return false;
                
                // Availability filter
                if (availability && commodity.status !== availability) return false;
                
                return true;
            });
            
            // Update display
            const commodityGrid = document.getElementById('commodityGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredCommodities.length === 0) {
                commodityGrid.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>No commodities match your filters</h3>
                    <p>Try adjusting your search criteria or browse all available commodities.</p>
                    <button class="btn-primary" onclick="clearFilters()" style="margin-top: 1rem;">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                `;
            } else {
                commodityGrid.style.display = 'grid';
                emptyState.style.display = 'none';
                
                // Clear and repopulate grid
                commodityGrid.innerHTML = '';
                filteredCommodities.forEach(commodity => {
                    const commodityCard = createCommodityCard(commodity);
                    commodityGrid.appendChild(commodityCard);
                });
            }
        }

        // Function to clear all filters
        function clearFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('priceRange').value = '1000';
            document.getElementById('locationFilter').value = '';
            document.getElementById('availabilityFilter').value = '';
            document.getElementById('priceRangeValue').textContent = '$0 - $1000';
            loadCommodities();
        }

        function addToWatchlist(commodityId) {
            const btn = event.target;
            const icon = btn.querySelector('i');
            
            // Get current watchlist
            let watchlist = JSON.parse(localStorage.getItem('userWatchlist')) || [];
            
            if (watchlist.includes(commodityId)) {
                // Remove from watchlist
                watchlist = watchlist.filter(id => id !== commodityId);
                icon.classList.remove('fas');
                icon.classList.add('far');
                btn.style.background = 'rgba(255, 255, 255, 0.9)';
                btn.style.color = '#475569';
            } else {
                // Add to watchlist
                watchlist.push(commodityId);
                icon.classList.remove('far');
                icon.classList.add('fas');
                btn.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
                btn.style.color = 'white';
            }
            
            // Save updated watchlist
            localStorage.setItem('userWatchlist', JSON.stringify(watchlist));
            console.log('Watchlist updated:', watchlist);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = loadUserFromSession();
            if (!currentUser) return;

            // Initialize sidebar user role
            document.getElementById('sidebarUserRole').textContent = currentUser.role || 'User';

            loadCommodities();

            // Initialize price range display
            document.getElementById('priceRangeValue').textContent = '$0 - $1000';

            // Auto-resize message input
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('negotiationModal');
                if (event.target === modal) {
                    closeNegotiationModal();
                }
            };

            // Enter key to send message in search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });

        // Navigation functions (simplified)
        function showSection(sectionId) {
            console.log('Showing section:', sectionId);
        }
    </script>
</body>
</html>
